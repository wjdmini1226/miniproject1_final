<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.project.dao.TestRestDao">

	<insert id="insert" parameterType="test_rest">
		INSERT INTO test_rest (
		t_r_idx,
		t_r_member,
		t_r_name,
		t_r_addr,
		t_r_menu,
		t_r_category
		) VALUES (
		seq_test_rest.NEXTVAL,
		#{t_r_member},
		#{t_r_name},
		#{t_r_addr},
		#{t_r_menu, jdbcType=VARCHAR },
		#{t_r_category}
		)
	</insert>
	
	<select id="selectList_admin" resultType="test_rest">
    SELECT * FROM 
    test_rest 
    ORDER BY t_r_idx DESC
	</select>

	<select id="selectList" resultType="test_rest">
		SELECT
		tr.*,
		(SELECT COUNT(*) FROM review v WHERE v.v_restaurant = tr.t_r_idx) as tr_v_count,	
		<!-- 레스토랑 r 리뷰 v 리뷰순으로 정렬 -->
		(SELECT AVG(v_score) FROM review v WHERE v.v_restaurant = tr.t_r_idx) as
		tr_avgscore	<!-- 평균별점으로 정렬 -->
		FROM test_rest tr
		<where>
			<if test="t_r_category != null">t_r_category = #{t_r_category}</if>
			<if test="searchKeyword != null">AND t_r_name LIKE '%' || #{searchKeyword} || '%'</if>
		</where>
		ORDER BY t_r_avgscore DESC NULLS LAST, tr.t_r_idx DESC
	</select>
	
	<!-- db와 몇글자 비슷한것 찾기 -->
	<select id="findSimilarRestaurant" resultType="test_rest">
		<![CDATA[
		    SELECT *
    		FROM test_rest
    		WHERE 
        	REPLACE(t_r_name, ' ', '') LIKE '%' || REPLACE(#{name}, ' ', '') || '%'
        	OR t_r_name LIKE '%' || #{keyword} || '%'
       	 	OR t_r_addr LIKE '%' || #{address} || '%'
    		ORDER BY t_r_idx DESC
	    ]]>
	</select>
	
	<!-- db와 몇글자 비슷한것 찾기2 -->
	<select id="searchByName" resultType="com.example.project.vo.TestRestVo">
        SELECT rest_idx, rest_name, rest_addr, rest_tel
        FROM restaurant
        WHERE rest_name LIKE '%' || #{keyword} || '%'
    </select>

	<select id="selectOne" parameterType="int"
		resultType="test_rest">
		SELECT * FROM test_rest
		WHERE t_r_member = #{m_idx}
	</select>

	<update id="update" parameterType="test_rest">
		UPDATE test_rest
		SET t_r_name = #{t_r_name},
		t_r_addr = #{t_r_addr},
		t_r_menu = #{t_r_menu},
		t_r_category = #{t_r_category}
		WHERE t_r_member = #{t_r_member}
	</update>

	<delete id="delete" parameterType="int">
		DELETE FROM test_rest
		WHERE t_r_idx = #{t_r_idx}
	</delete>
</mapper>